# Orshimo Tours - Deployment Guide

## ‚úÖ Admin Authentication on Render - FIXED!

**Admin panel now works on Render using username/password authentication!**

The application now supports TWO authentication methods:
- **Replit Auth** - Used automatically on Replit deployments
- **Username/Password** - Used on external deployments (Render, etc.)

**On Render, you can now:**
- ‚úÖ Login to admin panel with email/password
- ‚úÖ Create/edit/delete tours
- ‚úÖ View bookings
- ‚úÖ Manage tour availability calendar
- ‚úÖ Upload tour images
- ‚úÖ All admin features fully functional!

---

## üì¶ Push to GitHub

Since Git operations are restricted in Replit, you'll need to push your code manually. Here's how:

### Step 1: Download Your Project

1. In Replit, click the three dots menu (‚ãÆ) in the top right
2. Select **"Download as zip"**
3. Extract the zip file on your local machine

### Step 2: Push to GitHub

Open terminal in the extracted folder and run:

```bash
# Initialize git (if not already initialized)
git init

# Add your GitHub repository as remote
git remote add origin https://github.com/tengizalpenidze/orshimotours.git

# Stage all files
git add .

# Create initial commit
git commit -m "Initial commit - Orshimo Tours application"

# Push to GitHub
git push -u origin main
```

If you encounter authentication issues, use a Personal Access Token instead of password.

---

## üöÄ Deploy to Render

### Option 1: Using render.yaml (Recommended)

1. **Connect GitHub to Render**
   - Go to [Render Dashboard](https://dashboard.render.com/)
   - Click **"New +"** ‚Üí **"Blueprint"**
   - Connect your GitHub repository: `tengizalpenidze/orshimotours`
   - Render will automatically detect the `render.yaml` file

2. **Set Environment Variables**
   
   The following variables need to be set in Render:

   **Required:**
   - `DATABASE_URL` - Your PostgreSQL connection string (use Render's PostgreSQL or Neon)
   - `SENDGRID_API_KEY` - Your SendGrid API key
   
   **Auto-generated by render.yaml:**
   - `SESSION_SECRET` - Auto-generated secure random string
   - `ADMIN_EMAIL` - Pre-set to david.alpenidze@gmail.com
   - `FROM_EMAIL` - Pre-set to david.alpenidze@gmail.com

3. **Deploy**
   - Click **"Apply"** to create the service
   - Wait for the build to complete (~5-10 minutes)
   - Your app will be live at: `https://orshimo-tours.onrender.com`

### Option 2: Manual Setup

1. **Create New Web Service**
   - Go to [Render Dashboard](https://dashboard.render.com/)
   - Click **"New +"** ‚Üí **"Web Service"**
   - Connect your GitHub repository

2. **Configure Build Settings**
   - **Name:** `orshimo-tours`
   - **Runtime:** Node
   - **Build Command:** `npm install && npm run build`
   - **Start Command:** `npm start`

3. **Set Environment Variables**
   - Add all variables from `.env.example`
   - See "Required Environment Variables" section below

4. **Deploy**
   - Click **"Create Web Service"**
   - Wait for deployment to complete

---

## üóÑÔ∏è Database Setup on Render

### Option 1: Render PostgreSQL (Recommended)

1. In Render Dashboard, click **"New +"** ‚Üí **"PostgreSQL"**
2. Name it `orshimo-tours-db`
3. Choose a plan (Free tier available)
4. Copy the **External Database URL**
5. Add it as `DATABASE_URL` environment variable in your web service

### Option 2: Neon Database (Current Setup)

If you want to keep using Neon:
1. Go to [Neon Console](https://console.neon.tech/)
2. Copy your database connection string
3. Add it as `DATABASE_URL` in Render environment variables

### Run Database Migrations

After deploying, you may need to push your schema:

1. In Render dashboard, go to your web service
2. Open the **"Shell"** tab
3. Run: `npm run db:push`

---

## üîê Required Environment Variables

Copy these to Render's Environment Variables section:

### Essential Variables

```
DATABASE_URL=postgresql://user:password@host:5432/database
SESSION_SECRET=generate_random_string_here
SENDGRID_API_KEY=your_sendgrid_api_key
FROM_EMAIL=david.alpenidze@gmail.com
NODE_ENV=production
```

### Admin Authentication (NEW - Required for Render)

For admin panel access on Render, you MUST set these credentials:

```
ADMIN_EMAIL=your-admin-email@example.com
ADMIN_PASSWORD=your-secure-password
```

**Important:** 
- Choose a strong password (at least 12 characters)
- The admin user will be auto-created on first server start
- On Render, login with these credentials at `/admin`
- On Replit, Replit Auth is used automatically (these credentials are ignored)

### Required for File Uploads (Tour Images)

```
DEFAULT_OBJECT_STORAGE_BUCKET_ID=your_gcs_bucket_id
PRIVATE_OBJECT_DIR=.private
PUBLIC_OBJECT_SEARCH_PATHS=public
GOOGLE_PROJECT_ID=your_gcp_project_id
GOOGLE_CLIENT_EMAIL=your_service_account@project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYour_key_here\n-----END PRIVATE KEY-----\n"
```

---

## ‚òÅÔ∏è Google Cloud Storage Setup (REQUIRED)

**Important:** File uploads (tour images) will NOT work without proper GCS configuration.

### Step 1: Create a Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Click **"Select a project"** ‚Üí **"New Project"**
3. Name it (e.g., "orshimo-tours")
4. Click **"Create"**

### Step 2: Create a Storage Bucket

1. In Google Cloud Console, go to **Cloud Storage** ‚Üí **Buckets**
2. Click **"Create Bucket"**
3. Configuration:
   - **Name:** Choose a globally unique name (e.g., `orshimo-tours-uploads`)
   - **Location:** Choose region closest to your users
   - **Storage class:** Standard
   - **Access control:** Fine-grained (recommended)
   - **Public access:** Do NOT prevent public access (we need public URLs)
4. Click **"Create"**
5. Copy the bucket name - this is your `DEFAULT_OBJECT_STORAGE_BUCKET_ID`

### Step 3: Create a Service Account

1. In Google Cloud Console, go to **IAM & Admin** ‚Üí **Service Accounts**
2. Click **"Create Service Account"**
3. Details:
   - **Name:** `orshimo-tours-storage`
   - **Description:** "Service account for Orshimo Tours file uploads"
4. Click **"Create and Continue"**
5. Grant this role: **"Storage Object Admin"**
6. Click **"Continue"** ‚Üí **"Done"**

### Step 4: Create Service Account Key

1. Click on the service account you just created
2. Go to **"Keys"** tab
3. Click **"Add Key"** ‚Üí **"Create new key"**
4. Choose **JSON** format
5. Click **"Create"** - this downloads a JSON file
6. **Keep this file secure!** Never commit it to Git

### Step 5: Extract Credentials from JSON

Open the downloaded JSON file. You'll need these values:

```json
{
  "project_id": "your-project-id",           // ‚Üí GOOGLE_PROJECT_ID
  "private_key": "-----BEGIN PRIVATE...",    // ‚Üí GOOGLE_PRIVATE_KEY
  "client_email": "xxx@xxx.iam.gserviceaccount.com"  // ‚Üí GOOGLE_CLIENT_EMAIL
}
```

### Step 6: Set Environment Variables in Render

Go to your Render web service ‚Üí **Environment** tab and add:

```
DEFAULT_OBJECT_STORAGE_BUCKET_ID=your-bucket-name-from-step-2
GOOGLE_PROJECT_ID=your-project-id-from-json
GOOGLE_CLIENT_EMAIL=your-client-email-from-json
GOOGLE_PRIVATE_KEY=your-private-key-from-json
PRIVATE_OBJECT_DIR=.private
PUBLIC_OBJECT_SEARCH_PATHS=public
```

**Important:** For `GOOGLE_PRIVATE_KEY`, paste the entire value including:
```
-----BEGIN PRIVATE KEY-----
...key content...
-----END PRIVATE KEY-----
```

### Step 7: Test File Uploads

1. Deploy your app to Render
2. Log in to admin panel
3. Try uploading a tour image
4. If successful, the image URL will be from `storage.googleapis.com`

### Troubleshooting GCS

**Issue:** "Could not load the default credentials"
**Solution:** Verify all three Google credentials are set correctly in Render

**Issue:** "Access denied to bucket"
**Solution:** Ensure service account has "Storage Object Admin" role

**Issue:** "Bucket not found"
**Solution:** Verify `DEFAULT_OBJECT_STORAGE_BUCKET_ID` matches your bucket name exactly

---

## ‚úÖ Post-Deployment Checklist

1. **Test the Application**
   - Visit your Render URL
   - Try creating a tour
   - Test the booking flow
   - Verify email notifications work

2. **Verify SendGrid**
   - Ensure `david.alpenidze@gmail.com` is verified in SendGrid
   - Test booking confirmation emails

3. **Check Database**
   - Verify tours are saved
   - Check bookings are recorded
   - Test admin panel access

4. **Monitor Logs**
   - Check Render logs for any errors
   - Monitor application performance

---

## üêõ Troubleshooting

### Build Fails: "vite: not found" or "Cannot find package 'vite'"

**Issue:** Build fails with `sh: 1: vite: not found` or `Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'vite'`

**Solution:** This has been FIXED! The `render.yaml` now:
1. Uses `npm ci --include=dev` to ensure devDependencies (including vite) are installed during build
2. Uses `npx` to run vite and esbuild
3. Sets `NODE_ENV=production` only in the start command (not during build)

**Why it happens:** When `NODE_ENV=production` is set globally, `npm ci` skips devDependencies which includes build tools like vite and esbuild. By using `--include=dev` flag and moving NODE_ENV to the start command only, we ensure all necessary packages are available during build time.

### Build Fails: TypeScript Compilation Errors

**Issue:** TypeScript compilation errors
**Solution:** Check Render logs for specific errors. Ensure your TypeScript code compiles locally first with `npm run build`

### Database Connection Error

**Issue:** Cannot connect to database
**Solution:** 
- Verify `DATABASE_URL` is set correctly
- Check if database accepts external connections
- Run `npm run db:push` to sync schema

### Email Not Sending

**Issue:** SendGrid 403 error
**Solution:**
- Verify `david.alpenidze@gmail.com` in SendGrid dashboard
- Ensure API key has "Mail Send" permission
- Check `SENDGRID_API_KEY` is set correctly

### Port Error

**Issue:** Application not binding to correct port
**Solution:** Render automatically sets the `PORT` environment variable. Your app should use `process.env.PORT || 5000`

---

## üîÑ Continuous Deployment

Once connected to GitHub, Render will automatically:
- Deploy when you push to the `main` branch
- Run builds for pull requests
- Show deployment status in GitHub

To update your app:
1. Make changes locally
2. Commit and push to GitHub
3. Render auto-deploys the changes

---

## üìä Monitoring

### View Logs
1. Go to Render Dashboard
2. Click on your service
3. Navigate to **"Logs"** tab

### Check Metrics
1. In Render Dashboard
2. View **"Metrics"** tab for:
   - CPU usage
   - Memory consumption
   - Request rates

---

## üí∞ Pricing

### Render Free Tier
- ‚úÖ Suitable for testing
- ‚ö†Ô∏è Spins down after 15 minutes of inactivity
- ‚ö†Ô∏è Cold start ~30 seconds

### Render Starter ($7/month)
- ‚úÖ Always running
- ‚úÖ No cold starts
- ‚úÖ 512 MB RAM
- ‚úÖ Recommended for production

### Database Options
- Render PostgreSQL Free: 1GB storage, 90-day limit
- Render PostgreSQL Starter: $7/month, persistent
- Neon: Has free tier with generous limits

---

## üîó Useful Links

- [Render Documentation](https://render.com/docs)
- [Render Node.js Guide](https://render.com/docs/deploy-node-express-app)
- [SendGrid Setup](https://sendgrid.com/docs/ui/account-and-settings/api-keys/)
- [Neon Database](https://neon.tech/)

---

## üìù Notes

- **Custom Domain:** You can add a custom domain in Render settings
- **SSL:** Render provides free SSL certificates automatically
- **Scaling:** Upgrade your plan to scale horizontally with more instances
- **Backups:** Enable automated database backups in Render PostgreSQL settings

---

## üÜò Support

If you encounter issues:
1. Check Render logs for specific errors
2. Review this deployment guide
3. Check Render's status page: https://status.render.com/
4. Contact Render support: https://render.com/support

Your application is production-ready with proper error handling, email notifications, and database management! üéâ
